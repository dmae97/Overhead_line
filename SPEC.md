# ⚡ 한전 배전선로 여유용량 실시간 스캐너 - SPEC

> **프로젝트명**: Overhead Line Capacity Scanner  
> **버전**: 0.1.0  
> **작성일**: 2026-02-05  
> **상태**: Planning

---

## 1. 프로젝트 개요

### 1.1 목적
사용자가 선택한 지역(시/도 → 시/군/구 → 읍/면/동)에 대해 **한전(KEPCO) 배전선로 여유용량**을 실시간으로 조회하여, 태양광 발전사업 등 분산전원 연계 가능 여부를 빠르게 판단할 수 있는 웹 대시보드를 제공한다.

### 1.2 핵심 가치
- **On-Demand 지역 스캔**: 전국 단위가 아닌, 사용자가 선택한 지역 단위로 스캔
- **공식 API 우선**: Selenium 스크래핑이 아닌 한전 공식 REST API를 1차 데이터 소스로 활용
- **직관적 시각화**: Streamlit 기반의 인터랙티브 대시보드

### 1.3 대상 사용자
- 태양광 발전사업자 (토지 매입 전 선로용량 사전검토)
- 신재생에너지 컨설턴트
- 전기공사 업체 (계통연계 사전조사)

---

## 2. 데이터 소스

### 2.1 Primary: 한전 전력데이터 개방포털 REST API

| 항목 | 상세 |
|------|------|
| **엔드포인트** | `https://bigdata.kepco.co.kr/openapi/v1/dispersedGeneration.do` |
| **메서드** | GET, POST |
| **인코딩** | UTF-8 |
| **응답 포맷** | JSON, XML |
| **인증** | API Key (40자리, 회원가입 후 발급) |
| **비용** | 무료 |

#### 요청 파라미터

| 파라미터 | 설명 | 타입 | 필수 | 예시 |
|----------|------|------|------|------|
| `metroCd` | 시도코드 | STRING | 선택 | `44` (충청남도) |
| `cityCd` | 시군구코드 | STRING | 선택 | `131` (천안시 동남구) |
| `addrLidong` | 동/면 | STRING | 선택 | `광덕면` |
| `addrLi` | 리 | STRING | 선택 | `광덕리` |
| `addrJibun` | 상세번지 | STRING | 선택 | `142-1` |
| `substCd` | 변전소코드 | STRING | 선택 | |
| `apiKey` | API 인증키 | STRING | **필수** | 40자리 키 |
| `returnType` | 응답포맷 | STRING | 선택 | `json` / `xml` |

#### 응답 데이터

| 필드 | 설명 | 비고 |
|------|------|------|
| `substCd` | 변전소 코드 | |
| `substNm` | 변전소명 | |
| `jsSubstPwr` | 변전소 용량 | kW |
| `substPwr` | 변전소 누적 연계용량 | kW |
| `mtrNo` | 변압기 번호 | |
| `jsMtrPwr` | 변압기 용량 | kW |
| `mtrPwr` | 변압기 누적 연계용량 | kW |
| `dlCd` | DL(배전선로) 코드 | |
| `dlNm` | DL명 | 배전선로 이름 |
| `jsDlPwr` | DL 용량 | kW |
| `dlPwr` | DL 누적연계용량 | kW |
| `vol1` | **변전소 여유용량** | kW |
| `vol2` | **변압기 여유용량** | kW |
| `vol3` | **DL 여유용량** | kW |

#### 요청 예시
```
GET https://bigdata.kepco.co.kr/openapi/v1/dispersedGeneration.do
    ?metroCd=44
    &cityCd=131
    &addrLidong=광덕면
    &addrLi=광덕리
    &addrJibun=142-1
    &apiKey=YOUR_API_KEY
    &returnType=json
```

### 2.2 Secondary: 한전ON 웹사이트 (Selenium Fallback)

| 항목 | 상세 |
|------|------|
| **URL** | `https://home.kepco.co.kr/kepco/CO/H/E/COHEPP001/COHEPP00110.do?menuCd=FN420106` |
| **용도** | API로 조회 불가한 상세 정보 보완, 지도 기반 조회 |
| **방식** | Selenium + headless Chrome |
| **제약** | 봇 탐지, rate limiting, 동적 DOM |

### 2.3 주소 데이터: PublicDataReader

| 항목 | 상세 |
|------|------|
| **라이브러리** | `PublicDataReader` (pip) |
| **인증키** | 불필요 (코드 조회 시) |
| **핵심 API** | |

```python
import PublicDataReader as pdr

# 법정동코드 전체 조회 (인증키 불필요)
법정동코드 = pdr.code_bdong()
# 컬럼: 시도코드, 시도명, 시군구코드, 시군구명, 법정동코드, 읍면동명, 동리명, 생성일자, 말소일자

# 행정동코드 전체 조회 (인증키 불필요)
행정동코드 = pdr.code_hdong()
# 컬럼: 시도코드, 시도명, 시군구코드, 시군구명, 행정동코드, 읍면동명, 생성일자, 말소일자

# 행정동-법정동 연결정보
연결정보 = pdr.code_hdong_bdong()
```

---

## 3. 기능 요구사항

### 3.1 Core Features (MVP)

#### F1: 지역 선택 (Cascading Dropdown)
- 시/도 → 시/군/구 → 읍/면/동 3단계 드롭다운
- PublicDataReader 법정동코드 기반
- 말소되지 않은(현행) 법정동만 표시
- 선택 시 즉시 다음 단계 드롭다운 갱신
- 읍/면/동 단계에서 "전체" 옵션 제공
  - OpenAPI: 동/리 미지정으로 시군구 단위 조회 가능
  - API 키 미설정(브라우저 폴백) 모드에서는 "전체" 조회 미지원 (읍/면/동 선택 필요)

#### F2: 여유용량 조회 (API)
- 선택한 지역의 모든 배전선로 여유용량을 한전 API로 일괄 조회
- 조회 결과를 DataFrame 테이블로 표시
- 변전소 / 변압기 / DL 3레벨 여유용량 모두 표시
- 여유용량이 0인 선로 강조 표시 (위험 경고)

#### F3: 결과 시각화
- 여유용량 기준 색상 코딩 (초록/노랑/빨강)
- 변전소별 그룹핑 트리뷰
- 간단한 바 차트 (선로별 여유용량 비교)

#### F4: 데이터 내보내기
- CSV 다운로드
- Excel 다운로드

### 3.2 Extended Features (v2)

#### F5: 지도 시각화
- Folium 또는 Pydeck 기반 지도
- 변전소/선로 위치를 지도에 마커로 표시
- 여유용량 기반 색상 코딩 마커

#### F6: Selenium 상세 조회 (Fallback)
- API로 조회 불가한 경우 한전ON 웹 스크래핑
- 지번 주소 기반 검색 알고리즘
- 검색 대기/진행 상태 표시

#### F7: 이력 관리
- SQLite 로컬 DB에 조회 이력 저장
- 시간별 여유용량 변화 추적
- 이전 조회 결과와 비교 뷰

#### F8: 알림
- 특정 지역의 여유용량이 임계값 이하로 떨어지면 알림
- 이메일 또는 웹훅 기반

---

## 4. 기술 스택

| 카테고리 | 기술 | 버전 | 용도 |
|----------|------|------|------|
| **UI** | Streamlit | ≥1.30 | 웹 대시보드 |
| **HTTP** | httpx | ≥0.27 | 한전 API 호출 (async 지원) |
| **주소 데이터** | PublicDataReader | ≥1.1 | 법정동/행정동 코드 조회 |
| **데이터 처리** | pandas | ≥2.0 | DataFrame 처리 |
| **시각화** | plotly | ≥5.0 | 인터랙티브 차트 |
| **지도** | folium / pydeck | latest | 지도 시각화 (v2) |
| **스크래핑** | selenium | ≥4.0 | 한전ON 폴백 스크래핑 (v2) |
| **드라이버** | webdriver-manager | latest | ChromeDriver 자동 관리 |
| **DB** | sqlite3 | built-in | 조회 이력 저장 (v2) |
| **환경관리** | python-dotenv | latest | API Key 관리 |
| **패키지관리** | uv | latest | 의존성 관리 |
| **린팅** | ruff | latest | 코드 품질 |
| **테스트** | pytest | latest | 단위/통합 테스트 |

---

## 5. 비기능 요구사항

### 5.1 성능
- 시군구 단위 조회: **5초 이내** 응답 (API 기준)
- 동 단위 상세 조회: **2초 이내** 응답
- 법정동 코드 로딩: **앱 시작 시 1회**, 이후 캐시

### 5.2 보안
- API Key는 `.env` 파일로 관리, 절대 코드에 하드코딩 금지
- `.env`는 `.gitignore`에 반드시 포함
- Selenium 사용 시 개인정보 수집 금지

### 5.3 안정성
- API 호출 실패 시 retry (3회, exponential backoff)
- Selenium 폴백 시 명시적 타임아웃 (30초)
- 에러 발생 시 사용자에게 친화적인 메시지 표시

### 5.4 윤리/법적
- 한전 서버 부하 최소화: 요청 간 최소 1초 딜레이
- API 이용약관 준수
- robots.txt 확인 후 스크래핑 (Selenium 사용 시)

---

## 6. 한전 코드 체계

### 시도코드 (metroCd) - 법정 코드 기준

| 코드 | 시도명 |
|------|--------|
| 11 | 서울특별시 |
| 26 | 부산광역시 |
| 27 | 대구광역시 |
| 28 | 인천광역시 |
| 29 | 광주광역시 |
| 30 | 대전광역시 |
| 31 | 울산광역시 |
| 36 | 세종특별자치시 |
| 41 | 경기도 |
| 42 | 강원특별자치도 |
| 43 | 충청북도 |
| 44 | 충청남도 |
| 45 | 전북특별자치도 |
| 46 | 전라남도 |
| 47 | 경상북도 |
| 48 | 경상남도 |
| 50 | 제주특별자치도 |

> **참고**: 한전 API의 시도코드는 법정동코드의 앞 2자리와 동일합니다.
> PublicDataReader의 `시도코드` 컬럼을 그대로 매핑할 수 있습니다.

---

## 7. 주소 매핑 알고리즘

### 7.1 법정동코드 → 한전 API 파라미터 변환

```
PublicDataReader 법정동코드 구조:
┌──────────┬──────────┬───────────────┬──────────┬──────────┐
│ 시도코드  │ 시군구코드 │   법정동코드    │ 읍면동명  │  동리명   │
│  (2자리)  │  (5자리)  │   (10자리)     │          │          │
├──────────┼──────────┼───────────────┼──────────┼──────────┤
│    44     │  44131   │ 4413125000    │  광덕면   │          │
│    44     │  44131   │ 4413125021    │  광덕면   │  광덕리   │
└──────────┴──────────┴───────────────┴──────────┴──────────┘

한전 API 파라미터 매핑:
┌─────────────┬──────────────────────────────────┐
│ metroCd     │ 시도코드 (2자리) → "44"           │
│ cityCd      │ 시군구코드 뒤 3자리 → "131"       │
│ addrLidong  │ 읍면동명 → "광덕면"               │
│ addrLi      │ 동리명 → "광덕리"                 │
│ addrJibun   │ (선택) 번지 → "142-1"            │
└─────────────┴──────────────────────────────────┘
```

### 7.2 코드 변환 로직

```python
def bdong_to_kepco_params(row: pd.Series) -> dict:
    """법정동 DataFrame의 행을 한전 API 파라미터로 변환"""
    sido_code = str(row["시도코드"]).zfill(2)
    sigungu_code = str(row["시군구코드"]).zfill(5)
    
    return {
        "metroCd": sido_code,                    # 앞 2자리
        "cityCd": sigungu_code[2:],              # 뒤 3자리
        "addrLidong": row.get("읍면동명", ""),
        "addrLi": row.get("동리명", ""),
    }
```

---

## 8. 화면 설계 (와이어프레임)

### 8.1 메인 대시보드

```
┌─────────────────────────────────────────────────────┐
│  ⚡ 한전 배전선로 여유용량 스캐너                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [시/도 ▼]  [시/군/구 ▼]  [읍/면/동 ▼]  [🔍 조회]    │
│                                                     │
├─────────────────────────────────────────────────────┤
│  📊 조회 결과: 충청남도 천안시 서북구                    │
│                                                     │
│  ┌─────────────────────────────────────────────┐    │
│  │ 변전소    │ 변압기 │ DL명   │ DL용량 │ 여유용량 │    │
│  ├───────────┼────────┼────────┼────────┼────────┤    │
│  │ 천안      │ #1     │ 불당1  │ 10,000 │ 🟢3,200│    │
│  │ 천안      │ #1     │ 불당2  │ 10,000 │ 🟡1,500│    │
│  │ 천안      │ #2     │ 쌍용1  │ 10,000 │ 🔴  200│    │
│  │ 풍세      │ #1     │ 공원   │  7,890 │ 🟢4,100│    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
│  📈 여유용량 분포 [바차트]                             │
│  ████████████████░░░░  불당1: 3,200 kW              │
│  ██████████░░░░░░░░░░  불당2: 1,500 kW              │
│  ██░░░░░░░░░░░░░░░░░░  쌍용1:   200 kW              │
│  ████████████████████  공원:  4,100 kW               │
│                                                     │
│  [📥 CSV 다운로드]  [📥 Excel 다운로드]               │
└─────────────────────────────────────────────────────┘
```

### 8.2 색상 코딩 기준

| 여유용량 | 색상 | 의미 |
|----------|------|------|
| ≥ 3,000 kW | 🟢 초록 | 연계 가능 (여유) |
| 1,000~2,999 kW | 🟡 노랑 | 연계 가능 (주의) |
| 1~999 kW | 🟠 주황 | 연계 어려움 (한전 문의) |
| 0 kW | 🔴 빨강 | 연계 불가 |

---

## 9. 프로젝트 구조

```
Overhead_line/
├── .env.example          # API Key 템플릿
├── .env                  # 실제 API Key (gitignore)
├── .gitignore
├── AGENTS.md             # 프로젝트 개발 가이드라인
├── ARCHITECTURE.md       # 시스템 아키텍처 문서
├── SPEC.md               # 이 문서
├── README.md
├── pyproject.toml        # 프로젝트 메타데이터 + 의존성
├── requirements.txt      # pip 호환 의존성
│
├── src/
│   ├── __init__.py
│   ├── app.py            # Streamlit 메인 앱 (엔트리포인트)
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py     # 설정 관리 (환경변수, 상수)
│   │   └── exceptions.py # 커스텀 예외 클래스
│   │
│   ├── data/
│   │   ├── __init__.py
│   │   ├── address.py    # PublicDataReader 기반 주소 데이터 관리
│   │   ├── kepco_api.py  # 한전 REST API 클라이언트
│   │   ├── kepco_scraper.py  # 한전ON Selenium 스크래퍼 (v2)
│   │   └── models.py     # 데이터 모델 (Pydantic)
│   │
│   ├── ui/
│   │   ├── __init__.py
│   │   ├── components.py # 재사용 가능한 UI 컴포넌트
│   │   ├── sidebar.py    # 사이드바 (지역 선택)
│   │   ├── dashboard.py  # 메인 대시보드
│   │   └── charts.py     # 차트/시각화
│   │
│   └── utils/
│       ├── __init__.py
│       ├── cache.py      # Streamlit 캐싱 유틸
│       └── export.py     # CSV/Excel 내보내기
│
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_address.py
│   ├── test_kepco_api.py
│   └── test_models.py
│
└── data/
    └── .gitkeep          # 캐시 데이터 디렉토리
```

---

## 10. 마일스톤

### Phase 1: MVP (1주)
- [ ] 프로젝트 셋업 (pyproject.toml, 의존성)
- [ ] PublicDataReader 기반 주소 데이터 모듈
- [ ] 한전 API 클라이언트 모듈
- [ ] Streamlit 메인 UI (지역 선택 + 테이블)
- [ ] CSV/Excel 다운로드

### Phase 2: 시각화 강화 (1주)
- [ ] Plotly 바 차트
- [ ] 색상 코딩 적용
- [ ] 변전소별 그룹핑 뷰
- [ ] 조회 이력 (SQLite)

### Phase 3: 지도 + 스크래핑 (2주)
- [ ] Folium 지도 시각화
- [ ] Selenium 폴백 스크래퍼
- [ ] 지번 주소 검색 알고리즘
- [ ] 알림 시스템

---

## 11. 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| 한전 API Key 발급 지연 | MVP 블로킹 | Mock 데이터로 UI 먼저 개발, 이후 실제 API 연결 |
| API 응답 형식 변경 | 파싱 실패 | Pydantic 모델로 strict validation + 에러 핸들링 |
| API rate limit | 대량 조회 불가 | 요청 간 딜레이 + 캐싱 적극 활용 |
| 한전ON 사이트 구조 변경 | 스크래퍼 동작 불가 | 스크래퍼는 폴백 전용, API 우선 |
| PublicDataReader 법정동코드 ↔ 한전 코드 불일치 | 조회 실패 | 매핑 테이블 별도 관리 + 수동 보정 |
