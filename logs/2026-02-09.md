# 2026-02-09 작업 로그

## Session 1 - 00:00

### 작업 내용
- 요청 요약: 조회된 여유용량 데이터를 기반으로 지도/선로연결/실데이터 탭 추가 가능 여부 및 구현
- 수행한 작업 목록
  - 조회 이력 DB 스키마를 확장(비파괴 마이그레이션)해 지역/모드/통계 저장
  - Streamlit 탭에 `🗺️ 지도`, `🔗 선로 연결도`, `🧾 실데이터` 추가
  - 지도는 현재 데이터 제약(좌표/경로 없음) 때문에 시/도 중심점 기반 근사 표시로 구현
  - 선로 연결은 변전소→변압기→DL 계층 Sankey 그래프로 구현

### 변경된 파일
- `src/data/models.py` — QueryHistoryRecord에 메타/통계 필드 추가
- `src/data/history_db.py` — query_history 컬럼 추가 + ALTER TABLE 마이그레이션 + 저장/조회 확장
- `src/app.py` — 새 탭 추가, last_query 메타 저장, 이력 저장 중복 방지 및 통계 저장
- `src/ui/map_view.py` — 한반도 지도(조회 이력) 근사 시각화
- `src/ui/network_view.py` — 변전소→변압기→DL Sankey 연결도
- `src/ui/provenance_view.py` — 실데이터/원본(JSON) 및 출처 표시

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (114 passed)

## Session 4 - 00:00

### 작업 내용
- 요청 요약: Streamlit Cloud에서 지도 탭이 '조회 이력 없음'으로 비는 문제 해결
- 수행한 작업 목록
  - 이력 저장을 탭 렌더링 이전으로 이동(첫 조회에서도 지도에 표시)
  - DB가 비어있거나 저장 실패해도 세션/현재 조회 결과로 지도에 1개 이상 포인트 표시하는 폴백 추가

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (114 passed)

### 잔여 이슈
- OpenAPI/스크래핑 응답에 선로의 실제 지리 좌표/경로가 없어 지도에서 '실제 선로 경로 연결'은 현재는 근거 데이터가 부족함
- 더 정밀한 지도(시군구/읍면동) 표시를 원하면 centroid 데이터셋(예: 시군구 중심점 CSV) 또는 별도 지오코딩 API 연동이 필요

## Session 2 - 00:00

### 작업 내용
- 요청 요약: 최근 변경분 정확성/에러 여부 재검증
- 수행한 작업 목록
  - ruff/pytest 전체 재실행
  - 신규 UI 모듈 import 스모크 테스트
  - query_history 마이그레이션/저장/조회 임시 DB 스모크 테스트

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (114 passed)
- 임시 DB 마이그레이션/저장/조회 스모크 테스트 통과

## Session 3 - 00:00

### 작업 내용
- 요청 요약: Playwright 핵심 로직 코드 점검
- 수행한 작업 목록
  - Playwright 핵심은 `src/data/kepco_online.py`(EWM092D00)임을 확인하고 코드 리뷰
  - `_wait_for_results()`에서 `wait_for_function` 인자 전달 버그 수정 (list 대신 JSON string 전달하던 부분)

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (114 passed)

## Session 5 - 14:53

### 작업 내용
- 요청 요약: 지도/선로 상세조회 구현 상태 코드 리뷰
- 수행한 작업 목록
  - `src/ui/map_view.py`(조회 이력 지도)와 `src/ui/dashboard.py`(결과 테이블) 중심으로 현 구현 범위/제약 확인
  - 지도는 시/도 중심점 기반 근사치이며 선로 실제 좌표/경로는 미포함임을 확인
  - 선로 상세조회는 현재 테이블/그룹/연결도/실데이터(JSON)로 제공되고, 별도 드릴다운 UI는 없음을 정리

### 실행 결과
- `uv run pytest -q` 통과 (114 passed)

## Session 6 - 15:03

### 작업 내용
- 요청 요약: 지도 확대(zoom/pan) + 용량 색상 기준 선로 연결(근사) 구현
- 수행한 작업 목록
  - `src/ui/map_view.py`를 Plotly Mapbox(OpenStreetMap) 기반으로 변경해 줌/패닝 가능하게 함
  - 현재 조회 선로를 지역 중심점 주변에 안정적(jitter) 배치하고, 변전소/변압기 그룹 내 DL을 용량 기준으로 연결선 표시(초록/노랑/주황/빨강)
  - `src/app.py` 지도 탭을 '조회 이력' / '현재 선로(근사 연결)' 2개 서브탭으로 분리

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (114 passed)

## Session 7 - 15:19

### 작업 내용
- 요청 요약: 무료 지오메트리(OSM) 오버레이 + 파서 테스트 추가
- 수행한 작업 목록
  - `src/data/geo.py` 추가: Nominatim 지오코딩 + Overpass 전력선(power=*) geometry fetch + 파서 분리
  - `src/ui/map_view.py`에서 '공개 전력선 레이어(OSM/무료, 추정)' 체크 시 지도에 전력선 선형 오버레이
  - `tests/test_geo.py` 추가: Overpass JSON 파서 유닛 테스트

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (116 passed)

## Session 8 - 15:25

### 작업 내용
- 요청 요약: '리얼 느낌' 보강을 위한 선로 선택 + 하단 상세/연결 정보 추가
- 수행한 작업 목록
  - `src/ui/map_view.py`에 선로 선택(selectbox) 추가
  - 선택 선로를 지도에서 강조 표시하고, 하단에 용량(변전소/변압기/DL/최소여유)과 연결된 선로(같은 변전소/변압기) 테이블 표시

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (116 passed)

## Session 9 - 15:33

### 작업 내용
- 요청 요약: OSM 레이어를 배전 느낌 나게 필터 강화(1번 옵션)
- 수행한 작업 목록
  - `src/ui/map_view.py`에 OSM 필터 옵션 추가(배전 느낌, 최대 전압 kV, 최대 표시 선 수)
  - minor_line 우선 + 낮은 전압 우선 정렬 후 자동 다운샘플
  - `src/data/geo.py`에 voltage 파서(`parse_voltage_value`) 추가, `tests/test_geo.py`에 테스트 추가

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (117 passed)

## Session 10 - 16:03

### 작업 내용
- 요청 요약: 지도 연결 로직 테스트 보강 + 커밋 전 최종 검증
- 수행한 작업 목록
  - `src/ui/map_view.py` 스키매틱 연결 생성 로직을 함수로 분리해 테스트 가능하게 리팩토링
  - `tests/test_map_view_schematic.py` 추가: 연결선 색상(최소 여유 0 -> 빨강) 검증
  - ruff/pytest 최종 재실행

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (118 passed)

## Session 11 - 16:40

### 작업 내용
- 요청 요약: 지도/연결도 시인성 개선 + '지멋대로 움직임' 방지
- 수행한 작업 목록
  - `src/ui/network_view.py` Sankey를 fixed 레이아웃으로 고정하고(드래그 방지), 변전소/변압기 필터 + DL 표시 상한 추가
  - `src/ui/map_view.py` 지도 베이스를 carto-positron 기본으로 바꿔 시인성 개선, uirevision으로 줌/패닝 상태 유지
  - 지도 연결선을 DL 체인에서 수전→변압기→DL 구조로 변경하고(불가=빨강), 선/마커 두께/테두리 강화
  - `tests/test_map_view_schematic.py`는 스키매틱 빌더 반환값 변경에 맞춰 업데이트

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (118 passed)

## Session 12 - 17:03

### 작업 내용
- 요청 요약: 지도 선로 표시 확대 + 호버 이름 표시 + 클릭 시 사이드 상세 패널
- 수행한 작업 목록
  - `src/ui/map_view.py`에서 DL 마커/연결선 두께를 키우고 hoverlabel 시인성 개선
  - `st.plotly_chart(on_select='rerun')`로 클릭(포인트 선택) 이벤트를 받아 선택 선로를 세션에 저장
  - 지도 우측 컬럼에 선택 선로 상세/연결 선로 테이블을 표시하도록 레이아웃 변경

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (118 passed)

## Session 13 - 17:31

### 작업 내용
- 요청 요약: 읍/면(읍면동)에서 리 선택이 안 되어 조회가 실패하는 버그 수정
- 수행한 작업 목록
  - `src/ui/sidebar.py`에 '리(선택)' 드롭다운 추가(해당 읍/면/동에 리가 있을 때만 표시)
  - `src/data/address.py`에 `get_ri_list()` 추가 + 세종시(시군구명 빈 케이스) 처리 보강
  - `src/data/models.py`의 `RegionInfo`에 `ri` 필드 추가 및 display_name 반영
  - 한전ON 브라우저 조회 경로에도 ri 전달(`src/data/scraper_service.py`, `src/data/kepco_online.py`, `src/app.py`)
  - `tests/test_address.py`에 ri 목록/파라미터 매핑 테스트 추가

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (120 passed)

## Session 14 - 18:04

### 작업 내용
- 요청 요약: Streamlit Cloud에서 Sankey 슬라이더 예외(StreamlitAPIException) 디버깅/수정
- 수행한 작업 목록
  - `src/ui/network_view.py`의 DL 표시 상한 슬라이더를 step=1 + 값/범위 클램프 방식으로 변경해 예외 방지

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (120 passed)

## Session 15 - 18:51

### 작업 내용
- 요청 요약: Streamlit Cloud에서 새 탭(선로 연결도/지도/실데이터)에서 클릭/조작 시 에러/화면이 비는 문제 수정
- 수행한 작업 목록
  - `src/ui/network_view.py`: DL 표시 상한 슬라이더를 dl_total <= 10일 때 생략 + try/except 폴백
  - `src/ui/provenance_view.py`: records 1건일 때 slider(min==max) 예외 방지
  - `src/app.py`: 탭 렌더링 try/except 방어(개별 탭 오류가 앱 전체를 죽이지 않게)
  - `src/ui/map_view.py`: Scattermapbox의 미지원 marker.line 제거(Cloud plotly 호환)
  - `src/ui/map_view.py`: 지도 클릭 선택 처리 안정화(더블 rerun 제거), 위젯 key 고정, 빈 scope 폴백

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (120 passed)

## Session 16 - 19:14

### 작업 내용
- 요청 요약: 버튼/위젯 조작 시 조회 결과가 초기화되는 문제 해결(결과 유지)
- 수행한 작업 목록
  - `src/app.py`: 조회 버튼을 누르지 않은 rerun에서도 `last_records`/`last_data_label`로 이전 결과를 계속 표시
  - `src/app.py`: 조회 이력 저장이 rerun마다 중복되지 않도록 action_id 기반 1회 저장으로 변경
  - 업로드 파일도 rerun에서 재파싱/재저장을 줄이기 위해 file_id 기반 캐시 추가

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (120 passed)

## Session 17 - 19:30

### 작업 내용
- 요청 요약: 지도/선로 탭 조작 시 records가 None으로 돌아가며 결과가 사라지는 현상 추가 방어
- 수행한 작업 목록
  - `src/app.py`: main()에서 records=None이면 last_records로 강제 폴백(최후 안전망)
  - `src/app.py`: sidebar 일부 early-return/예외에서도 last_records로 폴백하도록 보강

### 실행 결과
- `uv run ruff check .` 통과
- `uv run pytest -q` 통과 (120 passed)
